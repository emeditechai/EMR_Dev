@model IEnumerable<EMR.Web.Models.ViewModels.PatientListItemViewModel>
@{
    ViewData["Title"] = "Patient List";
    var patients = Model?.ToList() ?? [];
}

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h1 class="h3 mb-0 fw-bold"><i class="bi bi-people-fill me-2 text-primary"></i>Patient Master</h1>
        <small class="text-muted">All registered OPD patients — @patients.Count record(s)</small>
    </div>

</div>

@if (!string.IsNullOrEmpty(TempData["Success"] as string))
{
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="dashboard-panel">
    @if (!patients.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-person-slash fs-1 text-muted mb-3 d-block opacity-50"></i>
            <h5 class="fw-semibold text-muted">No patients registered yet</h5>
            <p class="text-muted">Start by registering the first patient.</p>
            <a asp-action="PatientRegistration" class="btn btn-primary mt-2">
                <i class="bi bi-person-plus-fill me-1"></i>Register Patient
            </a>
        </div>
    }
    else
    {
        <div class="mb-3">
            <input type="text" id="tableSearch" class="form-control form-control-sm w-auto d-inline-block"
                   placeholder="Filter patients..." style="min-width:220px;" />
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="patientTable">
                <thead class="table-light">
                    <tr>
                        <th>Patient ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Gender</th>
                        <th>Blood Group</th>
                        <th>Doctor</th>
                        <th>Registered</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in patients)
                    {
                        <tr>
                            <td><span class="badge text-bg-info text-dark font-monospace">@p.PatientCode</span></td>
                            <td class="fw-semibold">@p.FullName</td>
                            <td>@p.PhoneNumber</td>
                            <td>
                                @if (p.Gender == "Male")
                                {
                                    <span class="badge text-bg-primary"><i class="bi bi-gender-male me-1"></i>Male</span>
                                }
                                else if (p.Gender == "Female")
                                {
                                    <span class="badge text-bg-danger"><i class="bi bi-gender-female me-1"></i>Female</span>
                                }
                                else
                                {
                                    <span class="badge text-bg-secondary">@(p.Gender ?? "--")</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(p.BloodGroup))
                                {
                                    <span class="badge text-bg-danger fw-bold">@p.BloodGroup</span>
                                }
                                else
                                {
                                    <span class="text-muted">--</span>
                                }
                            </td>
                            <td>@(p.ConsultingDoctorName ?? "--")</td>
                            <td class="text-muted small">@p.CreatedDate.ToString("dd MMM yyyy")</td>
                            <td>
                                @if (p.IsActive)
                                {
                                    <span class="badge text-bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge text-bg-secondary">Inactive</span>
                                }
                            </td>
                            <td class="text-end">
                                <a asp-action="PatientRegistration" asp-route-id="@p.PatientId"
                                   class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal" data-bs-target="#deleteModal"
                                        data-id="@p.PatientId" data-name="@p.FullName" title="Delete">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* Delete Confirmation Modal *@
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-trash me-2"></i>Delete Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete patient <strong id="deletePatientName"></strong>?</p>
                <p class="text-muted small">This will mark the patient as inactive. The record will not be permanently removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form asp-action="DeletePatient" method="post" id="deleteForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deletePatientId" />
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill me-1"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Delete modal
    document.getElementById('deleteModal')?.addEventListener('show.bs.modal', function (e) {
        const btn = e.relatedTarget;
        document.getElementById('deletePatientId').value = btn.dataset.id;
        document.getElementById('deletePatientName').textContent = btn.dataset.name;
    });

    // Table filter
    document.getElementById('tableSearch')?.addEventListener('input', function () {
        const val = this.value.toLowerCase();
        document.querySelectorAll('#patientTable tbody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(val) ? '' : 'none';
        });
    });
</script>
}


<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 fw-bold">Outpatient Department</h1>
        <small class="text-muted">OPD patient registration, appointments &amp; consultation queue</small>
    </div>
    <span class="badge text-bg-primary fs-6 px-3 py-2">OPD</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-sm-4">
        <div class="stat-card stat-blue">
            <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
            <div>
                <div class="stat-value">0</div>
                <div class="stat-label">Today's Appointments</div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="stat-card stat-green">
            <div class="stat-icon"><i class="bi bi-person-check"></i></div>
            <div>
                <div class="stat-value">0</div>
                <div class="stat-label">Consulted Today</div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="stat-card stat-yellow">
            <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
            <div>
                <div class="stat-value">0</div>
                <div class="stat-label">Waiting</div>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-panel p-4">
    <div class="text-center py-5">
        <i class="bi bi-hospital fs-1 text-primary mb-3 d-block"></i>
        <h5 class="fw-bold mb-1">OPD Module</h5>
        <p class="text-muted mb-0">OPD workflows — patient registration, appointments, consultation queue and prescriptions — can be built here.</p>
    </div>
</div>
